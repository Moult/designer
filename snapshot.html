<html>
    <head>
        <script src="https://code.createjs.com/easeljs-0.8.2.min.js"></script>
        <script src="https://code.createjs.com/tweenjs-0.6.2.min.js"></script>
    </head>
    <body onload="init();">
<style>
canvas { width: 350px; }
</style>
        <h1>Designer prototype</h1>
        arbitrary
        <canvas id="designer" width="500" height="500" style="border: 1px solid #F00;"></canvas>
        <canvas id="render" width="500" height="500" style="border: 1px solid #F00;"></canvas>
        <canvas id="map" width="500" height="500" style="border: 1px solid #F00;"></canvas>
        <canvas id="graphic" width="500" height="500" style="border: 1px solid #F00;"></canvas>
        <img src="template.png">
        <img src="shirt-specular.png">
<script>
var filters = {} || filters;
(function() {
	filters.ColorChannel = {
		RED: 0,
		GREEN: 1,
		BLUE: 2,
		ALPHA: 3
	};

	filters.Point = function(x, y) {
		this.x = x || 0;
		this.y = y || 0;
	};

	filters.DisplacementMap = function(source, map, target, point, scaleX, scaleY, channelX, channelY) {
		this.source = source;
		this.map = map;
		this.target = target;
		this.sourceCtx = this.source.getContext("2d");
		this.mapCtx = this.map.getContext("2d");
		this.targetCtx = this.target.getContext("2d");
		console.log(point);
		this.point = point || new filters.Point();
		this.scaleX = scaleX || 10;
		this.scaleY = scaleY || 10;
		this.channelX = channelX || filters.ColorChannel.RED;
		this.channelY = channelY || filters.ColorChannel.RED;
		if (this.channelX != 0 && this.channelX != 1 && this.channelX != 2 && this.channelX != 3) this.channelX = filters.ColorChannel.RED;
		if (this.channelY != 0 && this.channelY != 1 && this.channelY != 2 && this.channelY != 3) this.channelY = filters.ColorChannel.RED;
	};

	var p = filters.DisplacementMap.prototype;

	p.draw = function() {
		var sourceData = this.sourceCtx.getImageData(0, 0, this.source.width, this.source.height);
		var mapData = this.mapCtx.getImageData(0, 0, this.map.width, this.map.height);
		var targetDataX = this.sourceCtx.getImageData(0, 0, this.source.width,  this.source.height);
		var targetDataY = this.sourceCtx.getImageData(0, 0, this.source.width,  this.source.height);
		var pixelsLength = mapData.data.length / 4;
		var colorValue,
			alphaValue,
			ratio,
			ratioWithAlpha,
			pixelShift,
			sourcePosition,
			targetPosition,
			x,
			y;
		var i = 0;
		while(i < pixelsLength) {
			x = ((i % this.map.width) + this.point.x) | 0;
			y = (((i / this.map.width) | 0) + this.point.y) | 0;
			colorValue = mapData.data[i*4+this.channelX];
			alphaValue = mapData.data[i*4+filters.ColorChannel.ALPHA];
			ratio = (colorValue / 0xFF * 2) -1;
			ratioWithAlpha = ratio * (alphaValue / 0xFF);
			pixelShift = (ratioWithAlpha * this.scaleX | 0);
			sourcePosition = (this.source.width * y) + x;
			targetPosition = (this.target.width * y) + x + pixelShift;
			this.setPixels(targetDataX, targetPosition, sourceData, sourcePosition);
			i++;
		}
		i = 0;
		while(i < pixelsLength) {
			x = ((i % this.map.width) + this.point.x) | 0;
			y = (((i / this.map.width) | 0) + this.point.y) | 0;
			colorValue = mapData.data[i*4+this.channelY];
			alphaValue = mapData.data[i*4+filters.ColorChannel.ALPHA];
			ratio = (colorValue / 0xFF * 2) -1;
			ratioWithAlpha = ratio * (alphaValue / 0xFF);
			pixelShift = (ratioWithAlpha * this.scaleY | 0);
			sourcePosition = (this.source.width * y) + x;
			targetPosition = (this.target.width * (y + pixelShift)) + x;
			this.setPixels(targetDataY, targetPosition, targetDataX, sourcePosition);
			i++;
		}
		this.targetCtx.putImageData(targetDataY, 0, 0);
	};

	p.setPixels = function(target, pos, source, i) {
		target.data[i*4] = source.data[pos*4];
		target.data[i*4+1] = source.data[pos*4+1];
		target.data[i*4+2] = source.data[pos*4+2];
		target.data[i*4+3] = source.data[pos*4+3];
	};
})();



function init() {
    var sourceStage = new createjs.Stage('graphic');
    var renderStage = new createjs.Stage('render');
    var stage = new createjs.Stage('designer');
    var productImage = new Image();
    var productBitmap;
    productImage.src = 'shirt-textured.png';
    productImage.onload = function(event) {
        var productBitmap = new createjs.Bitmap('shirt-textured.png');
        productBitmap.x = 0;
        productBitmap.y = 0;
        stage.addChild(productBitmap);
        stage.update();

        var graphicImage = new Image();
        graphicImage.src = 'dolphin.png';
        graphicImage.onload = function(event) {
            var graphicBitmap = new createjs.Bitmap('dolphin.png');
            graphicBitmap.on('mousedown', function(event) {
                var local = event.currentTarget.globalToLocal(event.stageX, event.stageY),
                    nx = event.currentTarget.regX - local.x,
                    ny = event.currentTarget.regY - local.y;
                event.currentTarget.regX = local.x;
                event.currentTarget.regY = local.y;
                event.currentTarget.x -= nx;
                event.currentTarget.y -= ny;
            });
            graphicBitmap.on('pressmove', function(event) {
                this.x = event.stageX;
                this.y = event.stageY;
                stage.update();
            });
            graphicBitmap.on('pressup', function(event) {
                var cloneBitmap = new createjs.Bitmap('dolphin.png');
                cloneBitmap.regX = event.currentTarget.regX;
                cloneBitmap.regY = event.currentTarget.regY;
                cloneBitmap.x = event.currentTarget.x;
                cloneBitmap.y = event.currentTarget.y;
                var sourceCanvas = document.getElementById('graphic');
                var sourceContext = sourceCanvas.getContext('2d');
                sourceContext.clearRect(0, 0, sourceCanvas.width, sourceCanvas.height);
                sourceStage.removeAllChildren();
                sourceStage.addChild(cloneBitmap);
                sourceStage.update();
                console.log('time to render');

                var image = new Image();
                image.src = 'template.png';
                sourceContext.globalCompositeOperation = 'destination-in';
                // sourceContext.drawImage(image, 125, 50, 250, 250);
                sourceContext.drawImage(image, 135, 50, 350, 350);

                var filter = new filters.DisplacementMap(document.getElementById('graphic'),
                        document.getElementById('map'),
                        document.getElementById('graphic'));
                filter.draw();
                var image = new Image();
                image.src = 'shirt.png';
                sourceContext.drawImage(image, 0, 0);
                // sourceContext.globalCompositeOperation = 'lighten';
                // sourceContext.drawImage(image, 0, 0);
                sourceContext.globalCompositeOperation = 'source-over';

                renderStage.removeAllChildren();
                var productBitmap = new createjs.Bitmap('shirt-textured.png');
                renderStage.addChild(productBitmap);
                var compositeBitmap = new createjs.Bitmap(document.getElementById('graphic'));
                // compositeBitmap.alpha = 0.5;
                // compositeBitmap.compositeOperation = 'screen';
                compositeBitmap.alpha = 1;
                compositeBitmap.compositeOperation = 'multiply'; // multiply for lighter tshirts
                renderStage.addChild(compositeBitmap);

                var specularBitmap = new createjs.Bitmap('shirt-specular.png');
                specularBitmap.alpha = 0.8;
                specularBitmap.compositeOperation = 'overlay';
                renderStage.addChild(specularBitmap);
                renderStage.update();
            });
            stage.addChild(graphicBitmap);
            stage.update();
        }
    }


    function drawImageOnCanvas(imageSrc, canvasId, callback) {
        var canvas = document.getElementById(canvasId);
        var context = canvas.getContext('2d');
        var image = new Image();
        image.addEventListener('load', function() {
            context.drawImage(this, 0, 0);
            callback();
        });
        image.src = imageSrc;
    }

    drawImageOnCanvas('shirt.png', 'map');
}
</script>
    </body>
</html>
